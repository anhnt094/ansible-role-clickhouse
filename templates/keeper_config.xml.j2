{% if clickhouse_config_format == 'xml' %}
<?xml version="1.0"?>
<!--
  ClickHouse Keeper Configuration
  Generated by Ansible - ansible-role-clickhouse
-->
<clickhouse>
    <logger>
        <level>information</level>
        <log>{{ clickhouse_path_log }}/clickhouse-keeper.log</log>
        <errorlog>{{ clickhouse_path_log }}/clickhouse-keeper.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
    </logger>

    <listen_host>{{ clickhouse_listen_host }}</listen_host>

    <keeper_server>
        <tcp_port>{{ clickhouse_keeper_port }}</tcp_port>
        <server_id>{{ clickhouse_keeper_id | default(1) }}</server_id>
        <log_storage_path>{{ clickhouse_keeper_path }}/logs</log_storage_path>
        <snapshot_storage_path>{{ clickhouse_keeper_path }}/snapshots</snapshot_storage_path>

        <coordination_settings>
            <operation_timeout_ms>10000</operation_timeout_ms>
            <session_timeout_ms>30000</session_timeout_ms>
            <raft_logs_level>information</raft_logs_level>
        </coordination_settings>

        <raft_configuration>
{% for host in groups['clickhouse_keeper'] | default([]) %}
            <server>
                <id>{{ hostvars[host]['clickhouse_keeper_id'] }}</id>
                <hostname>{{ hostvars[host]['access_ip'] | default(hostvars[host]['ip']) | default(hostvars[host]['ansible_host']) }}</hostname>
                <port>{{ clickhouse_keeper_raft_port }}</port>
            </server>
{% endfor %}
        </raft_configuration>
    </keeper_server>
</clickhouse>
{% elif clickhouse_config_format == 'yaml' %}
# ClickHouse Keeper Configuration
# Generated by Ansible - ansible-role-clickhouse

clickhouse:
  logger:
    level: information
    log: {{ clickhouse_path_log }}/clickhouse-keeper.log
    errorlog: {{ clickhouse_path_log }}/clickhouse-keeper.err.log
    size: 1000M
    count: 10

  listen_host: {{ clickhouse_listen_host }}

  keeper_server:
    tcp_port: {{ clickhouse_keeper_port }}
    server_id: {{ clickhouse_keeper_id | default(1) }}
    log_storage_path: {{ clickhouse_keeper_path }}/logs
    snapshot_storage_path: {{ clickhouse_keeper_path }}/snapshots

    coordination_settings:
      operation_timeout_ms: 10000
      session_timeout_ms: 30000
      raft_logs_level: information

    raft_configuration:
      server:
{% for host in groups['clickhouse_keeper'] | default([]) %}
        - id: {{ hostvars[host]['clickhouse_keeper_id'] }}
          hostname: {{ hostvars[host]['access_ip'] | default(hostvars[host]['ip']) | default(hostvars[host]['ansible_host']) }}
          port: {{ clickhouse_keeper_raft_port }}
{% endfor %}
{% endif %}
