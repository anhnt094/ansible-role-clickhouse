{% if clickhouse_config_format == 'xml' %}
<?xml version="1.0"?>
<!--
  Cluster Configuration
  Generated by Ansible - ansible-role-clickhouse
  Best Practice: Keep default config.xml unchanged, add customizations in config.d/
-->
<clickhouse>
    <!-- Remote servers (cluster configuration) -->
    <remote_servers>
        <{{ clickhouse_cluster_name }}>
{% for shard_id in groups['clickhouse_cluster'] | map('extract', hostvars, 'clickhouse_shard') | default([1]) | unique | list | sort %}
            <shard>
                <internal_replication>true</internal_replication>
{% for host in groups['clickhouse_cluster'] %}
{% if hostvars[host]['clickhouse_shard'] | default(1) == shard_id %}
                <replica>
                    <host>{{ hostvars[host]['access_ip'] | default(hostvars[host]['ip']) | default(hostvars[host]['ansible_host']) }}</host>
                    <port>{{ clickhouse_tcp_port }}</port>
                </replica>
{% endif %}
{% endfor %}
            </shard>
{% endfor %}
        </{{ clickhouse_cluster_name }}>
    </remote_servers>

    <!-- Macros for distributed DDL -->
    <macros>
        <cluster>{{ clickhouse_cluster_name }}</cluster>
        <shard>{{ clickhouse_shard_id }}</shard>
        <replica>{{ inventory_hostname }}</replica>
    </macros>

    <!-- Distributed DDL -->
    <distributed_ddl>
        <path>/clickhouse/task_queue/ddl</path>
    </distributed_ddl>
</clickhouse>
{% elif clickhouse_config_format == 'yaml' %}
# Cluster Configuration
# Generated by Ansible - ansible-role-clickhouse

clickhouse:
  remote_servers:
    {{ clickhouse_cluster_name }}:
{% for shard_id in groups['clickhouse_cluster'] | map('extract', hostvars, 'clickhouse_shard') | default([1]) | unique | list | sort %}
      shard_{{ shard_id }}:
        internal_replication: true
        replicas:
{% for host in groups['clickhouse_cluster'] %}
{% if hostvars[host]['clickhouse_shard'] | default(1) == shard_id %}
          - host: {{ hostvars[host]['access_ip'] | default(hostvars[host]['ip']) | default(hostvars[host]['ansible_host']) }}
            port: {{ clickhouse_tcp_port }}
{% endif %}
{% endfor %}
{% endfor %}

  macros:
    cluster: {{ clickhouse_cluster_name }}
    shard: {{ clickhouse_shard_id }}
    replica: {{ inventory_hostname }}

  distributed_ddl:
    path: /clickhouse/task_queue/ddl
{% endif %}
